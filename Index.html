<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Focus Engine</title>
</head>
<body>
<script>
/**
 * AURA FOCUS ENGINE - Standalone JavaScript Edition
 * Updated to connect to the Aura2 Render Server
 */
(function() {
    const CONFIG = {
        USER_ID: "17040095986901884715",
        STORAGE_KEY: "aura_focus_v4_"
    };

    const State = {
        sessions: [],
        activeId: null,
        isBusy: false,

        init() {
            const saved = localStorage.getItem(CONFIG.STORAGE_KEY + CONFIG.USER_ID);
            if (saved) {
                try {
                    this.sessions = JSON.parse(saved);
                    this.activeId = this.sessions[0]?.id || this.createNewSession().id;
                } catch (e) { this.createNewSession(); }
            } else { this.createNewSession(); }
        },

        save() { localStorage.setItem(CONFIG.STORAGE_KEY + CONFIG.USER_ID, JSON.stringify(this.sessions)); },

        createNewSession() {
            const id = Date.now().toString();
            const newSession = { id, title: "New Deep Work", task: "", messages: [], minutes: 0 };
            this.sessions.unshift(newSession);
            this.activeId = id;
            this.save();
            return newSession;
        },

        getActive() { return this.sessions.find(s => s.id === this.activeId); },

        deleteSession(id) {
            this.sessions = this.sessions.filter(s => s.id !== id);
            if (this.activeId === id) this.activeId = this.sessions[0]?.id || this.createNewSession().id;
            this.save();
        }
    };

    const API = {
        // --- UPDATED: Now talks to YOUR Render Server ---
        async callAuraServer(message) {
            const response = await fetch('/aura-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    apiKey: "Auraapi" // Your custom server password
                })
            });
            return await response.json();
        },

        async searchDDG(query) {
            const res = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1`);
            return await res.json();
        }
    };

    const UI = {
        root: null,
        injectStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono&display=swap');
                :root { --bg: #0b0f1a; --sidebar: #111827; --accent: #6366f1; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
                * { box-sizing: border-box; }
                body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #e5e7eb; height: 100vh; display: flex; overflow: hidden; }
                .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
                .main { flex: 1; display: flex; flex-direction: column; position: relative; }
                .header { height: 64px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; justify-content: space-between; }
                .chat-container { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
                .input-container { padding: 24px; background: linear-gradient(to top, var(--bg) 80%, transparent); }
                .input-wrapper { max-width: 800px; margin: 0 auto; background: var(--glass); border: 1px solid var(--border); border-radius: 16px; padding: 8px; display: flex; align-items: center; backdrop-filter: blur(10px); }
                input[type="text"] { background: transparent; border: none; color: white; flex: 1; padding: 12px 16px; outline: none; font-size: 14px; }
                button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 500; }
                .session-link { padding: 12px 16px; margin: 4px 12px; border-radius: 10px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
                .session-link.active { background: rgba(99, 102, 241, 0.15); color: var(--accent); font-weight: 600; }
                .msg { max-width: 80%; padding: 14px 18px; border-radius: 18px; font-size: 14px; line-height: 1.6; }
                .msg-user { align-self: flex-end; background: white; color: black; border-bottom-right-radius: 4px; }
                .msg-bot { align-self: flex-start; background: var(--glass); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
                .research-panel { background: #1e3a8a33; border: 1px solid #3b82f644; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
                .mono { font-family: 'JetBrains Mono', monospace; font-size: 11px; opacity: 0.5; }
            `;
            document.head.appendChild(style);
        },

        render() {
            const active = State.getActive();
            this.root.innerHTML = `
                <div class="sidebar">
                    <div style="padding: 24px; border-bottom: 1px solid var(--border)">
                        <h3 style="margin: 0 0 4px 0">Aura Engine</h3>
                        <div class="mono">UID: ${CONFIG.USER_ID}</div>
                        <button onclick="window.AuraApp.newSession()" style="width: 100%; margin-top: 20px; background: rgba(255,255,255,0.05)">+ New Focus</button>
                    </div>
                    <div id="session-list" style="flex: 1; overflow-y: auto; padding-top: 12px;"></div>
                </div>
                <div class="main">
                    <div class="header">
                        <input id="task-trigger" onchange="window.AuraApp.updateTask(this.value)" value="${active.task}" placeholder="What are we focusing on?" style="background:transparent; border:none; color:white; font-weight: 600; font-size: 15px; width: 250px; outline:none;">
                        <div style="display:flex; gap:12px;">
                            <button onclick="window.AuraApp.research()" style="background:#2563eb; font-size:12px;">Research</button>
                            <div style="background:var(--glass); padding: 8px 16px; border-radius: 20px; font-size: 12px;">${active.minutes}m</div>
                        </div>
                    </div>
                    <div class="chat-container" id="chat-scroller">
                        <div id="tool-view"></div>
                        <div id="msg-history" style="display:flex; flex-direction:column; gap:16px;"></div>
                    </div>
                    <div class="input-container">
                        <div class="input-wrapper">
                            <input id="chat-input" type="text" placeholder="Where are you stuck?">
                            <button id="send-btn" onclick="window.AuraApp.send()">Ask Aura</button>
                        </div>
                    </div>
                </div>
            `;
            this.updateList();
            this.updateMessages();
        },

        updateList() {
            const list = document.getElementById('session-list');
            list.innerHTML = State.sessions.map(s => `
                <div class="session-link ${s.id === State.activeId ? 'active' : ''}" onclick="window.AuraApp.load('${s.id}')">
                    <span>${s.title}</span>
                    <span onclick="event.stopPropagation(); window.AuraApp.remove('${s.id}')" style="opacity:0.3;">âœ•</span>
                </div>
            `).join('');
        },

        updateMessages() {
            const hist = document.getElementById('msg-history');
            const active = State.getActive();
            hist.innerHTML = active.messages.map(m => `
                <div class="msg ${m.role === 'user' ? 'msg-user' : 'msg-bot'}">${m.text}</div>
            `).join('');
            const scroller = document.getElementById('chat-scroller');
            scroller.scrollTop = scroller.scrollHeight;
        }
    };

    window.AuraApp = {
        init() {
            State.init();
            UI.root = document.createElement('div');
            UI.root.style.display = 'contents';
            document.body.appendChild(UI.root);
            UI.injectStyles();
            UI.render();
            document.addEventListener('keydown', e => { if (e.key === 'Enter' && document.activeElement.id === 'chat-input') this.send(); });
            setInterval(() => { const active = State.getActive(); active.minutes++; State.save(); UI.render(); }, 60000);
        },
        newSession() { State.createNewSession(); UI.render(); },
        load(id) { State.activeId = id; UI.render(); },
        remove(id) { State.deleteSession(id); UI.render(); },
        updateTask(val) { const active = State.getActive(); active.task = val; active.title = val.substring(0, 15) || "New Session"; State.save(); UI.updateList(); },
        async research() {
            const active = State.getActive();
            if (!active.task) return;
            const view = document.getElementById('tool-view');
            view.innerHTML = `<div class="research-panel">Searching...</div>`;
            const data = await API.searchDDG(active.task);
            view.innerHTML = `<div class="research-panel"><strong>${data.Heading || active.task}</strong><br>${data.AbstractText || 'No summary.'}</div>`;
        },
        async send() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || State.isBusy) return;

            const active = State.getActive();
            active.messages.push({ role: 'user', text });
            input.value = '';
            UI.updateMessages();

            State.isBusy = true;
            try {
                // Connect to Render Server
                const data = await API.callAuraServer(text);
                active.messages.push({ role: 'bot', text: data.reply || data.error });
                State.save();
                UI.updateMessages();
            } catch (e) {
                active.messages.push({ role: 'bot', text: "Server connection failed." });
                UI.updateMessages();
            } finally { State.isBusy = false; }
        }
    };
    window.onload = () => window.AuraApp.init();
})();
</script>
</body>
</html>
