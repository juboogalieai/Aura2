<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Focus Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px border rgba(255, 255, 255, 0.05);
        }

        .gradient-blur {
            position: fixed;
            z-index: -1;
            filter: blur(100px);
            opacity: 0.15;
            pointer-events: none;
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.1); }
        }

        .animate-pulse-slow { animation: pulse-slow 8s infinite ease-in-out; }
    </style>
</head>
<body class="h-screen flex">

    <!-- Background Decoration -->
    <div class="gradient-blur top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-600 animate-pulse-slow"></div>
    <div class="gradient-blur bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-blue-600"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-80 h-full glass border-r border-white/10 flex flex-col transition-all duration-300 z-50">
        <div class="p-6 border-b border-white/5">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-xl bg-purple-600 flex items-center justify-center shadow-lg shadow-purple-900/40">
                    <i class="fas fa-brain text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-white tracking-tight">Aura Engine</h1>
                    <p class="text-[10px] text-white/40 mono" id="display-user-id">ID: 17040095986901884715</p>
                </div>
            </div>
            <button onclick="createNewSession()" class="w-full py-2.5 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 transition-all border border-white/5 active:scale-95">
                <i class="fas fa-plus"></i> New Focus Session
            </button>
        </div>

        <div id="session-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
            <!-- Sessions injected here -->
        </div>

        <div class="p-4 border-t border-white/5 bg-black/20">
            <div class="flex items-center justify-between px-2">
                <span class="text-[10px] text-white/30 font-bold uppercase tracking-widest">Device History</span>
                <button onclick="clearAllData()" class="text-white/20 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt text-xs"></i></button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative min-w-0 h-full">
        <!-- Header -->
        <header class="h-16 glass border-b border-white/5 flex items-center justify-between px-6 shrink-0">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-2 text-white/60 hover:text-white transition-colors">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center gap-3">
                    <span id="header-title" class="text-sm font-semibold text-white/90 truncate">New Session</span>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex bg-black/40 p-1 rounded-lg border border-white/5">
                    <button onclick="setMood('Coach')" class="mood-btn px-3 py-1 text-[10px] font-bold rounded-md text-white/40" id="mood-Coach">Coach</button>
                    <button onclick="setMood('Balanced')" class="mood-btn px-3 py-1 text-[10px] font-bold rounded-md bg-purple-600 text-white" id="mood-Balanced">Balanced</button>
                    <button onclick="setMood('Supporter')" class="mood-btn px-3 py-1 text-[10px] font-bold rounded-md text-white/40" id="mood-Supporter">Supporter</button>
                </div>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-full border border-white/10 text-[10px] mono">
                    <i class="fas fa-clock text-purple-400"></i>
                    <span id="session-timer">0m</span>
                </div>
            </div>
        </header>

        <!-- Focus Context Bar -->
        <section class="p-4 glass border-b border-white/5 space-y-4 shrink-0">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="relative">
                    <i class="fas fa-crosshairs absolute left-3 top-2.5 text-emerald-400 text-xs"></i>
                    <input id="task-input" type="text" placeholder="Active Task (Search Query)..." class="w-full bg-black/20 border border-white/10 rounded-xl py-2 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-emerald-500/50 transition-colors" oninput="updateContext()">
                </div>
                <div class="relative">
                    <i class="fas fa-fire absolute left-3 top-2.5 text-orange-400 text-xs"></i>
                    <input id="why-input" type="text" placeholder="Why does this matter? (Goal)..." class="w-full bg-black/20 border border-white/10 rounded-xl py-2 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-orange-500/50 transition-colors" oninput="updateContext()">
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <button onclick="runResearch()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[11px] font-bold uppercase tracking-wider hover:bg-blue-500/20 transition-all">
                    <i class="fas fa-search"></i> Quick Research
                </button>
                <button onclick="runSmartPlan()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[11px] font-bold uppercase tracking-wider hover:bg-emerald-500/20 transition-all">
                    <i class="fas fa-list-check"></i> Smart Plan
                </button>
                <button onclick="speakLastMessage()" id="speak-btn" class="px-4 py-2 rounded-lg bg-pink-500/10 border border-pink-500/20 text-pink-400 text-[11px] font-bold uppercase tracking-wider hover:bg-pink-500/20 transition-all">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>

            <!-- Tool Output Card (Hidden by default) -->
            <div id="tool-output" class="hidden relative p-4 bg-black/60 border border-white/10 rounded-xl shadow-2xl animate-in zoom-in-95">
                <button onclick="closeToolOutput()" class="absolute top-3 right-3 text-white/30 hover:text-white"><i class="fas fa-times"></i></button>
                <div id="tool-content" class="text-sm"></div>
            </div>
        </section>

        <!-- Messages Container -->
        <section id="messages" class="flex-1 overflow-y-auto p-6 md:p-10 space-y-6 custom-scrollbar">
            <!-- Intro State -->
            <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-30 text-center space-y-4">
                <i class="fas fa-sparkles text-4xl text-purple-400"></i>
                <p class="text-lg font-light">Focus Engine Standby.<br><span class="text-sm opacity-60">Set a task above to begin.</span></p>
            </div>
        </section>

        <!-- Input Area -->
        <footer class="p-6 bg-gradient-to-t from-[#0f172a] to-transparent shrink-0">
            <div class="max-w-4xl mx-auto flex items-center bg-white/5 backdrop-blur-2xl border border-white/10 rounded-2xl p-1.5 shadow-2xl focus-within:border-purple-500/50 transition-all">
                <input id="chat-input" type="text" placeholder="Tell Aura where your head is at..." class="flex-1 bg-transparent text-white px-4 py-3 focus:outline-none placeholder:text-white/20 text-sm" onkeydown="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="p-3 bg-purple-600 text-white rounded-xl hover:bg-purple-500 transition-all active:scale-95">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </footer>
    </main>

    <script>
        // --- Configuration ---
        const USER_ID = "17040095986901884715";
        const API_KEY = ""; // Environment handles this
        const MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        // --- State Management ---
        let chatHistory = [];
        let currentChatId = null;
        let messages = [];
        let task = "";
        let why = "";
        let sessionMinutes = 0;
        let mood = "Balanced";
        let isSidebarOpen = true;

        // --- Initialization ---
        window.onload = () => {
            document.getElementById('display-user-id').innerText = `ID: ${USER_ID}`;
            loadFromStorage();
            
            // Timer
            setInterval(() => {
                sessionMinutes++;
                document.getElementById('session-timer').innerText = `${sessionMinutes}m`;
                saveToStorage();
            }, 60000);
        };

        // --- Core Functions ---

        function loadFromStorage() {
            const data = localStorage.getItem(`aura_data_${USER_ID}`);
            if (data) {
                chatHistory = JSON.parse(data);
                if (chatHistory.length > 0) {
                    loadSession(chatHistory[0].id);
                } else {
                    createNewSession();
                }
            } else {
                createNewSession();
            }
            renderSessionList();
        }

        function saveToStorage() {
            if (!currentChatId) return;
            
            const index = chatHistory.findIndex(s => s.id === currentChatId);
            const currentSession = {
                id: currentChatId,
                title: task ? (task.length > 25 ? task.substring(0, 25) + "..." : task) : (messages.length > 0 ? messages[0].text.substring(0, 25) + "..." : "New Focus Session"),
                messages,
                task,
                why,
                sessionMinutes,
                mood,
                lastUpdated: Date.now()
            };

            if (index > -1) {
                chatHistory[index] = currentSession;
            } else {
                chatHistory.unshift(currentSession);
            }
            
            localStorage.setItem(`aura_data_${USER_ID}`, JSON.stringify(chatHistory));
            renderSessionList();
        }

        function createNewSession() {
            currentChatId = Date.now().toString();
            messages = [];
            task = "";
            why = "";
            sessionMinutes = 0;
            mood = "Balanced";
            
            document.getElementById('task-input').value = "";
            document.getElementById('why-input').value = "";
            document.getElementById('header-title').innerText = "New Focus Session";
            document.getElementById('session-timer').innerText = "0m";
            setMood('Balanced');
            renderMessages();
            saveToStorage();
        }

        function loadSession(id) {
            const session = chatHistory.find(s => s.id === id);
            if (session) {
                currentChatId = session.id;
                messages = session.messages || [];
                task = session.task || "";
                why = session.why || "";
                sessionMinutes = session.sessionMinutes || 0;
                mood = session.mood || "Balanced";

                document.getElementById('task-input').value = task;
                document.getElementById('why-input').value = why;
                document.getElementById('header-title').innerText = session.title;
                document.getElementById('session-timer').innerText = `${sessionMinutes}m`;
                setMood(mood);
                renderMessages();
                closeToolOutput();
            }
        }

        function deleteSession(id, event) {
            event.stopPropagation();
            chatHistory = chatHistory.filter(s => s.id !== id);
            localStorage.setItem(`aura_data_${USER_ID}`, JSON.stringify(chatHistory));
            if (currentChatId === id) {
                if (chatHistory.length > 0) loadSession(chatHistory[0].id);
                else createNewSession();
            }
            renderSessionList();
        }

        function renderSessionList() {
            const list = document.getElementById('session-list');
            list.innerHTML = '';
            chatHistory.forEach(session => {
                const item = document.createElement('div');
                item.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all border ${currentChatId === session.id ? 'bg-purple-600/20 border-white/20 text-white shadow-lg' : 'hover:bg-white/5 border-transparent text-slate-400'}`;
                item.onclick = () => loadSession(session.id);
                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fas fa-comment-dots text-xs ${currentChatId === session.id ? 'text-purple-400' : 'text-slate-600'}"></i>
                        <span class="truncate text-xs font-medium">${session.title}</span>
                    </div>
                    <button onclick="deleteSession('${session.id}', event)" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 transition-opacity"><i class="fas fa-times text-[10px]"></i></button>
                `;
                list.appendChild(item);
            });
        }

        // --- UI Interactions ---

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            isSidebarOpen = !isSidebarOpen;
            sidebar.style.width = isSidebarOpen ? '320px' : '0px';
        }

        function setMood(m) {
            mood = m;
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('text-white/40');
            });
            const active = document.getElementById(`mood-${m}`);
            active.classList.add('bg-purple-600', 'text-white');
            active.classList.remove('text-white/40');
            saveToStorage();
        }

        function updateContext() {
            task = document.getElementById('task-input').value;
            why = document.getElementById('why-input').value;
            saveToStorage();
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            const emptyState = document.getElementById('empty-state');
            
            if (messages.length === 0) {
                emptyState.classList.remove('hidden');
                container.innerHTML = '';
                container.appendChild(emptyState);
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `flex gap-4 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                div.innerHTML = `
                    <div class="flex gap-3 max-w-[85%] ${msg.role === 'user' ? 'flex-row-reverse' : 'flex-row'}">
                        <div class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center ${msg.role === 'user' ? 'bg-white text-black' : 'bg-gradient-to-tr from-purple-600 to-blue-500 text-white shadow-lg'}">
                            <i class="fas fa-${msg.role === 'user' ? 'user' : 'robot'} text-xs"></i>
                        </div>
                        <div class="p-4 rounded-2xl text-[13.5px] leading-relaxed shadow-xl ${msg.role === 'user' ? 'bg-white text-slate-900 rounded-tr-none font-medium' : 'bg-white/10 backdrop-blur-md border border-white/10 text-white rounded-tl-none font-light'}">
                            <div class="whitespace-pre-wrap">${msg.text}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // --- External Tools ---

        async function runResearch() {
            if (!task.trim()) return showToolOutput("error", "Add a search term to the task input first.");
            
            showToolOutput("loading", "Scanning DuckDuckGo...");
            try {
                const res = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(task)}&format=json&no_html=1`);
                const data = await res.json();
                
                if (data.AbstractText) {
                    showToolOutput("search", `
                        <div class="space-y-2">
                            <h3 class="text-blue-400 font-bold text-xs uppercase tracking-wider">${data.Heading || task}</h3>
                            <p class="text-white/80 leading-relaxed">${data.AbstractText}</p>
                            <a href="${data.AbstractURL}" target="_blank" class="text-[10px] text-blue-400 hover:underline">Source: ${data.AbstractSource}</a>
                        </div>
                    `);
                } else {
                    showToolOutput("error", "No summary found. Try a broader topic.");
                }
            } catch (e) {
                showToolOutput("error", "Search failed. Check connection.");
            }
        }

        async function runSmartPlan() {
            if (!task.trim()) return showToolOutput("error", "Define your task above first.");
            
            showToolOutput("loading", "Engineering ADHD-friendly plan...");
            try {
                const prompt = `Task: "${task}". Goal: "${why}". Create a "Game Plan" for someone with ADHD. Break it down into micro-steps, pitfalls, and one dopamine tip.`;
                const system = `Return JSON format: { "plan": ["step1", "step2"], "pitfalls": ["pitfall1"], "dopamineTip": "tip" }`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: 'user', parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: system }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const data = await response.json();
                const json = JSON.parse(data.candidates[0].content.parts[0].text);
                
                showToolOutput("plan", `
                    <div class="space-y-3">
                        <h3 class="text-emerald-400 font-bold text-[11px] uppercase tracking-widest"><i class="fas fa-list-check mr-2"></i> Adaptive Blueprint</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <ul class="space-y-1.5">
                                ${json.plan.map((s, i) => `<li class="text-xs text-white/90 flex gap-2"><span class="text-emerald-500 font-mono">0${i+1}</span> ${s}</li>`).join('')}
                            </ul>
                            <div class="space-y-3">
                                <p class="text-[10px] text-red-400 font-bold uppercase">Watch Out:</p>
                                <p class="text-xs text-red-100/60 italic">${json.pitfalls.join(', ')}</p>
                                <div class="p-3 bg-yellow-500/10 rounded-lg border border-yellow-500/20">
                                    <p class="text-[10px] text-yellow-500 font-bold uppercase mb-1">Dopamine Tip</p>
                                    <p class="text-xs text-yellow-100/90">${json.dopamineTip}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            } catch (e) {
                showToolOutput("error", "AI Planner failed.");
            }
        }

        function showToolOutput(type, content) {
            const el = document.getElementById('tool-output');
            const target = document.getElementById('tool-content');
            el.classList.remove('hidden');
            
            if (type === 'loading') {
                target.innerHTML = `<div class="flex items-center gap-3 text-white/50"><i class="fas fa-circle-notch animate-spin"></i> ${content}</div>`;
            } else {
                target.innerHTML = content;
            }
        }

        function closeToolOutput() {
            document.getElementById('tool-output').classList.add('hidden');
        }

        // --- Chat AI ---

        async function sendMessage() {
            const inputEl = document.getElementById('chat-input');
            const text = inputEl.value.trim();
            if (!text) return;

            messages.push({ role: 'user', text });
            inputEl.value = '';
            renderMessages();

            const moodGuides = {
                "Coach": "Aggressive, high-energy, no-excuses coach style. Push the user hard.",
                "Supporter": "Gentle, compassionate, highly encouraging therapist style. Focus on empathy.",
                "Balanced": "Pragmatic, structured assistant style. Focus on logic and steps."
            };

            const systemPrompt = `You are Aura, an ADHD-focused focus assistant. 
            User Persona: Has ADHD. 
            Current Mood: ${moodGuides[mood]}
            Active Task: ${task}
            Goal: ${why}
            Session Duration: ${sessionMinutes}m
            Your ID: ${USER_ID}
            Be concise. Use bullet points for steps. Never judge.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: messages.map(m => ({
                            role: m.role === 'user' ? 'user' : 'model',
                            parts: [{ text: m.text }]
                        })),
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const data = await response.json();
                const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Connection lost. Try again?";
                messages.push({ role: 'bot', text: botText });
                renderMessages();
                saveToStorage();
            } catch (e) {
                messages.push({ role: 'bot', text: "Brain fog... (API Error). Make sure you have an internet connection." });
                renderMessages();
            }
        }

        // --- Audio Features ---

        async function speakLastMessage() {
            const lastMsg = messages.filter(m => m.role === 'bot').pop();
            if (!lastMsg) return;

            const btn = document.getElementById('speak-btn');
            btn.innerHTML = `<i class="fas fa-spinner animate-spin"></i>`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say this supportively: ${lastMsg.text}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });
                
                const result = await response.json();
                const pcmData = result.candidates[0].content.parts[0].inlineData.data;
                const audioBlob = pcmToWav(pcmData, 24000);
                const audio = new Audio(URL.createObjectURL(audioBlob));
                audio.play();
                audio.onended = () => { btn.innerHTML = `<i class="fas fa-volume-up"></i>`; };
            } catch (e) {
                btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
                setTimeout(() => { btn.innerHTML = `<i class="fas fa-volume-up"></i>`; }, 2000);
            }
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const byteCharacters = atob(base64Pcm);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
            const pcmBuffer = new Uint8Array(byteNumbers).buffer;
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmBuffer.byteLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmBuffer.byteLength, true);
            return new Blob([wavHeader, pcmBuffer], { type: 'audio/wav' });
        }

        function clearAllData() {
            if (confirm("Clear all session history on this device?")) {
                localStorage.removeItem(`aura_data_${USER_ID}`);
                chatHistory = [];
                createNewSession();
            }
        }
    </script>
</body>
</html>
